#cloud-config

# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# https://hub.docker.com/r/nginx/nginx/
# https://nginx.io/manual/toc/#installation

users:
  - name: gitlab-runner
    uid: 2000

write_files:
  - path: /var/lib/docker/daemon.json
    permissions: 0644
    owner: root
    content: |
      {
        "live-restore": true,
        "storage-driver": "overlay2",
        "log-opts": {
          "max-size": "1024m"
        }
      }

  # gitlab-runner container service
  - path: /etc/systemd/system/gitlab-runner.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      Description=Start gitlab runner containers
      After=gcr-online.target docker.socket
      Wants=gcr-online.target docker.socket docker-events-collector.service
      [Service]
      Environment="HOME=/home/gitlab-runner"
      ExecStartPre=/usr/bin/docker-credential-gcr configure-docker --registries ${region}-docker.pkg.dev
      ExecStart=/usr/bin/docker run \
      -v /run/gitlab-runner:/etc/gitlab-runner \
      ${repo_url}/gitlab/gitlab-runner
      ExecStop=/usr/bin/docker rm -f $(docker ps -a -q)

bootcmd:
  - systemctl start node-problem-detector

runcmd:
  - iptables -I INPUT 1 -p tcp -m tcp --dport 3001 -m state --state NEW,ESTABLISHED -j ACCEPT
  - systemctl daemon-reload
%{ if gitlab_executor_type == "docker-autoscaler" }
  # Install GCP fleeting plugin for Docker Autoscale Runner
  # https://docs.gitlab.com/runner/executors/docker_autoscaler.html#install-a-fleeting-plugin
  - wget https://gitlab.com/gitlab-org/fleeting/fleeting-plugin-googlecompute/-/releases/v0.1.0/downloads/fleeting-plugin-googlecompute-linux-386
  - chmod +x fleeting-plugin-googlecompute-linux-386
  - mv ./fleeting-plugin-googlecompute-linux-386 /usr/bin/fleeting-plugin-googlecompute
%{ endif }
  - mkdir -p /run/gitlab-runner/certs
  - echo "${gitlab_ca_cert}" | base64 -d -w0 > /run/gitlab-runner/certs/ca.crt
  # Fetch the gitlab auth token value from secret manager
  - export HOME=/tmp && /usr/bin/docker-credential-gcr configure-docker --registries ${region}-docker.pkg.dev
  - docker run --rm -v /run/gitlab-runner:/etc/gitlab-runner ${repo_url}/gitlab/gitlab-runner register --non-interactive --url="https://${gitlab_hostname}" --token="${gitlab_token}" --executor="${gitlab_executor_type}" --docker-image="alpine:latest"
  - systemctl restart gitlab-runner
