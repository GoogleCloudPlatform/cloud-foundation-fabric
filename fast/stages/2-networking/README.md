# Shared Networking Resources

<!-- BEGIN TOC -->
- [Quickstart](#quickstart)
  - [Factory data set](#factory-data-set)
  - [Defaults file](#defaults-file)
  - [Terraform vars configuration](#terraform-vars-configuration)
  - [Linking FAST output files](#linking-fast-output-files)
  - [Terraform init/apply cycle](#terraform-initapply-cycle)
- [Design overview and choices](#design-overview-and-choices)
  - [Networking projects](#networking-projects)
  - [VPCs](#vpcs)
  - [DNS](#dns)
  - [Hub-and-spoke topologies](#hub-and-spoke-topologies)
- [Files](#files)
- [Variables](#variables)
- [Outputs](#outputs)
<!-- END TOC -->

This stage sets up the networking infrastructure for the organization. It provides a flexible, factory-based approach to defining and managing networking resources, including

- VPCs
  - Subnets
  - VPC Firewall rules
  - Routes
  - DNS policies
- DNS
  - Forwarding, Public, Private Zones
  - RPZ
- Firewall policies
- VPC connectivity
  - NCC
  - NVA (multi-nic router instances)
  - VPC Peering
  - VPN

Several common networking patterns are also available as "[recipes](recipes/)" that can be easily used as is or adapted as needed.

## Quickstart

This stage is designed to be applied after stage 0, but as any other FAST stage it can also be used in isolation, provided the required prerequisites are met. This section details the FAST usage, where prerequisites are already in place.

The high-level flow for running this stage is:

- check the **factory data set** as configured in `var.factories_config` and do any necessary edits to match your configuration (VPCs, Subnetting, DNS zones, Onprem connectivity, etc.)
- review the **defaults.yaml file** for your chosen recipe with attributes matching your configuration
- define a simple tfvars file if your dataset is in a non-standard path, and/or you want local output files (recommended for initial setups)
- bring in or link the prerequisite files generated by the previous stage
- run `terraform init` and `apply`

### Factory data set

The default dataset provides multiple different "recipes".

- **Hub and spoke (w/ NCC)**: Multiple VPCs interconnected through NCC, which allows for easier scalability ([recipe](./recipes/hub-and-spokes-ncc/))

- **Hub and spoke (w/ NVA)**: Environment-based VPCs interconnected through a cluster of NVAs (router instances), allowing for instance-based packet inspection between different networks ([recipe](./recipes/hub-and-spokes-nva/))

- **Hub and spoke (w/ VPC Peering)**: Environment-based VPCs interconnected through VPC peering, resulting in full isolation between spokes ([recipe](./recipes/hub-and-spokes-peerings/))

- **Hub and spoke (w/ VPC Peering)**: Environment-based VPCs interconnected through GCP-to-GCP VPNs ([recipe](./recipes/hub-and-spokes-vpn/))

#### Single VPC: TODO

### Defaults file

Configurations defaults are stored in the `defaults.yaml` file in the selected dataset. Relocating the defaults file is good practice to avoid accidental changes from upstream, this is done via the `factories_config.default` variable attribute.

Once a suitable place has been found for the file, edit it to match the desired configuration. Several pieces of information coming from the previous stage (prefix, billing account, etc.) are pre-populated in the project defaults so they don't need to be explicitly set.

### Terraform vars configuration

A tfvars file allows you to control paths for the project factories data, and to enable local output files generation. This example shows how to override all the factory paths and how to enable output files.

```hcl
factories_config = {
  defaults              = "/some/path/data/defaults.yaml"
  dns                   = "/some/path/data/dns/zones"
  dns-response-policies = "/some/path/data/dns/response-policies"
  firewall-policies     = "/some/path/data/firewall-policies"
  folders               = "/some/path/data/folders"
  interconnect          = "/some/path/data/interconnect"
  ncc-hubs              = "/some/path/data/ncc-hubs"
  nvas                  = "/some/path/data/nvas"
  projects              = "/some/path/data/projects"
  vpcs                  = "/some/path/data/vpcs"
}
outputs_location = "~/fast-config"
```

### Linking FAST output files

If you enabled local output files in the previous stage, run this command replacing the example path with the one for your output files.

```bash
../fast-links.sh ~/fast-config

# File linking commands for networking stage

# provider file
ln -s ~/fast-config/providers/2-networking-providers.tf ./

# input files from other stages
ln -s ~/fast-config/tfvars/0-globals.auto.tfvars.json ./
ln -s ~/fast-config/tfvars/0-org-setup.auto.tfvars.json ./

# conventional location for this stage terraform.tfvars (manually managed)
ln -s ~/fast-config/2-networking.auto.tfvars ./
```

If you have no local output files, check the previous state's outputs for the name of your GCS outputs bucket and replace it in the example below.

```bash
../fast-links.sh gs://myprefix-prod-iac-org-0-iac-outputs

# File linking commands for networking stage

# provider file
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/providers/2-networking-providers.tf ./

# input files from other stages
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/tfvars/0-globals.auto.tfvars.json ./
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/tfvars/0-org-setup.auto.tfvars.json ./

# conventional location for this stage terraform.tfvars (manually managed)
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/2-networking.auto.tfvars ./
```

Once you have one of the above outputs, copy/paste it in your terminal from within this stage's folder.

Note that the last command in both outputs is optional: this is our recommended best practice to centrally store the tfvars file you created for this stage. If this convention works for you, move the tfvars file created in the previous steps to the path shown in the output, then run the command.

### Terraform init/apply cycle

Once everything is set up, simply run the usual `init`/`apply` cycle.

```bash
terraform init
terraform apply
```

## Design overview and choices

```tree
.
├── dns                     
│   ├── response-policies   # Canonical path for RPZ. 
                            # Each file is a collection of rules created in a 
                            # given project and bound to an arbitrary number of
                            # VPCs. Files can optionally be grouped in folders.

│   └── zones               # Canonical path for DNS zones. 
│       ├── net-core-0      # Each file is the configuration for a single zone, 
│       ├── net-dev-0       # created in a given project and bound to an 
│       └── net-prod-0      # arbitrary number of VPCs. Files can optionally be
                            # grouped in folders, as in this example.

├── firewall-policies       # Canonical path for firewall policies (VPC and 
                            # Hierarchical).
                            # Each file is a policy, created in a given parent 
                            # (typically a folder), and attached to an 
                            # arbitrary number of resource-hierarchy objects.
                            # Files can optionally be grouped in folders.

├── projects                # Canonical path for projects.
                            # Refer to the project-factory module for 
                            # comprehensive documentation

└── vpcs                    # Canonical path for VPCs configuration
                            # Each sub folder is a VPC 
                            # (in this example foo/, bar/)

    ├── foo                 # For each VPC, the .config.yaml file contains the 
                            # configuration (implementing most of the net-vpc 
                            # variable surface in yaml), and how that VPC 
                            # connects to the internet (via nat_config) or 
                            # other VPCs (via peering_config and ncc_config)

        ├── firewall-rules  # VPC Firewall rules factory path, implemented as 
                            # a net-vpc-firewall factory

        ├── subnets         # Subnets factory path, implemented as subfactory 
                            # of the net-vpc module

        └── vpns            # VPN factory path. Each file describes a VPN 
                            # gateway, a peer, and a trunk of VPN tunnels. Both
                            # GCP-to-GCP and GCP-to-external peers are supported


```

### Networking projects

A [project factory](../../../modules/project-factory/) is embedded in this stage ([factory-projects.tf](./factory-projects.tf)) to allow for the creation of one or multiple projects where the networking resources will be deployed.

The project factory is configured via YAML files in the `projects` directory of your chosen recipe. Each file defines a project, its services, and IAM bindings.

Note that the stage doesn't force you to create projects - as all the factories allow for passing an externally-managed project id.

### VPCs

The VPC factory allows for the definition of an arbitrary number of VPCs, along with subnets, routes, firewall rules and VPC connectivity in YAML files.

VPCs are defined in `.config.yaml` files within the `vpcs` directory of a recipe. Each subdirectory of the `vpcs` directory corresponds to a VPC. The `.config.yaml` file contains the VPC's configuration.

Subnets, firewall rules and VPNs are defined in subdirectories within each VPC's directory.

### DNS

The DNS factory allows for the definition of Cloud DNS zones and records, including RPZ.

DNS zones are defined in YAML files in the `dns/zones` directory of your chosen recipe. The factory supports forwarding, peering and private zones, as well as DNS response policies in the `dns/response-policies`.

### Cloud NAT and Routers

- **Cloud NAT:** The `factory-cloudnat.tf` file manages Cloud NAT gateways, allowing instances without external IP addresses to access the internet.

- **Cloud Routers:** The `factory-routers.tf` file manages Cloud Routers, which are used with Cloud VPN and Cloud Interconnect to exchange routes between your VPC network and your on-premises network.

## Extending your infrastructure

TODO: describe how to use module outputs to extend the infra

<!-- TFDOC OPTS files:1 -->
<!-- BEGIN TFDOC -->
<!-- END TFDOC -->
