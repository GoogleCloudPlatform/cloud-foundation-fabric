# Shared Networking Resources

<!-- BEGIN TOC -->
- [Quickstart](#quickstart)
  - [Factory data set](#factory-data-set)
  - [Defaults file](#defaults-file)
  - [Terraform vars configuration](#terraform-vars-configuration)
  - [Linking FAST output files](#linking-fast-output-files)
  - [Terraform init/apply cycle](#terraform-initapply-cycle)
- [Design overview and choices](#design-overview-and-choices)
  - [Networking projects](#networking-projects)
  - [VPCs](#vpcs)
  - [DNS](#dns)
  - [Cloud NAT and Routers](#cloud-nat-and-routers)
- [Context-based interpolation](#context-based-interpolation)
- [Files](#files)
- [Variables](#variables)
- [Outputs](#outputs)
<!-- END TOC -->

This stage sets up the networking infrastructure for the organization. It provides a flexible, factory-based approach to defining and managing networking resources, including

- VPCs
  - Subnets
  - VPC Firewall rules
  - Routes
  - DNS policies
- DNS
  - Forwarding, Public, Private Zones
  - RPZ
- Firewall policies
- VPC connectivity
  - NCC
  - NVA (multi-nic router instances)
  - VPC Peering
  - VPN

Several common networking patterns will also be available as "[datasets](datasets/)" that can be easily used as is or adapted as needed.

## Quickstart

This stage is designed to be applied after stage 0, but as any other FAST stage it can also be used in isolation, provided the required prerequisites are met. This section details the FAST usage, where prerequisites are already in place.

The high-level flow for running this stage is:

- check the **factory data set** as configured in `var.factories_config` and do any necessary edits to match your configuration (VPCs, Subnetting, DNS zones, Onprem connectivity, etc.)
- review the **defaults.yaml file** for your chosen dataset with attributes matching your configuration
- define a simple tfvars file if your dataset is in a non-standard path, and/or you want local output files (recommended for initial setups)
- bring in or link the prerequisite files generated by the previous stage
- run `terraform init` and `apply`

### Factory data set

The default dataset will eventually multiple different networking patterns.
It currently implements the following:

- **Hub and spoke (w/ VPC Peering)**: Environment-based VPCs interconnected through VPC peering, resulting in full isolation between spokes ([dataset](./datasets/hub-and-spokes-peerings/))

### Defaults file

Configurations defaults are stored in the `defaults.yaml` file in the selected dataset. Relocating the defaults file is good practice to avoid accidental changes from upstream, this is done via the `factories_config.default` variable attribute.

Once a suitable place has been found for the file, edit it to match the desired configuration. Several pieces of information coming from the previous stage (prefix, billing account, etc.) are pre-populated in the project defaults so they don't need to be explicitly set.

### Terraform vars configuration

A tfvars file allows you to control paths for the project factories data, and to enable local output files generation. This example shows how to override all the factory paths and how to enable output files.

```hcl
factories_config = {
  defaults              = "/some/path/data/defaults.yaml"
  dns                   = "/some/path/data/dns/zones"
  dns-response-policies = "/some/path/data/dns/response-policies"
  firewall-policies     = "/some/path/data/firewall-policies"
  folders               = "/some/path/data/folders"
  interconnect          = "/some/path/data/interconnect"
  ncc-hubs              = "/some/path/data/ncc-hubs"
  nvas                  = "/some/path/data/nvas"
  projects              = "/some/path/data/projects"
  vpcs                  = "/some/path/data/vpcs"
}
outputs_location = "~/fast-config"
```

### Linking FAST output files

If you enabled local output files in the previous stage, run this command replacing the example path with the one for your output files.

```bash
../fast-links.sh ~/fast-config

# File linking commands for networking stage

# provider file
ln -s ~/fast-config/providers/2-networking-providers.tf ./

# input files from other stages
ln -s ~/fast-config/tfvars/0-globals.auto.tfvars.json ./
ln -s ~/fast-config/tfvars/0-org-setup.auto.tfvars.json ./

# conventional location for this stage terraform.tfvars (manually managed)
ln -s ~/fast-config/2-networking.auto.tfvars ./
```

If you have no local output files, check the previous state's outputs for the name of your GCS outputs bucket and replace it in the example below.

```bash
../fast-links.sh gs://myprefix-prod-iac-org-0-iac-outputs

# File linking commands for networking stage

# provider file
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/providers/2-networking-providers.tf ./

# input files from other stages
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/tfvars/0-globals.auto.tfvars.json ./
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/tfvars/0-org-setup.auto.tfvars.json ./

# conventional location for this stage terraform.tfvars (manually managed)
gcloud storage cp gs://myprefix-prod-iac-org-0-iac-outputs/2-networking.auto.tfvars ./
```

Once you have one of the above outputs, copy/paste it in your terminal from within this stage's folder.

Note that the last command in both outputs is optional: this is our recommended best practice to centrally store the tfvars file you created for this stage. If this convention works for you, move the tfvars file created in the previous steps to the path shown in the output, then run the command.

### Terraform init/apply cycle

Once everything is set up, simply run the usual `init`/`apply` cycle.

```bash
terraform init
terraform apply
```

## Design overview and choices

```tree
.
├── dns                     
│   ├── response-policies   # Canonical path for RPZ. 
                            # Each file is a collection of rules created in a 
                            # given project and bound to an arbitrary number of
                            # VPCs. Files can optionally be grouped in folders.

│   └── zones               # Canonical path for DNS zones. 
│       ├── net-core-0      # Each file is the configuration for a single zone, 
│       ├── net-dev-0       # created in a given project and bound to an 
│       └── net-prod-0      # arbitrary number of VPCs. Files can optionally be
                            # grouped in folders, as in this example.

├── firewall-policies       # Canonical path for firewall policies (VPC and 
                            # Hierarchical).
                            # Each file is a policy, created in a given parent 
                            # (typically a folder), and attached to an 
                            # arbitrary number of resource-hierarchy objects.
                            # Files can optionally be grouped in folders.

├── projects                # Canonical path for projects.
                            # Refer to the project-factory module for 
                            # comprehensive documentation

└── vpcs                    # Canonical path for VPCs configuration
                            # Each sub folder is a VPC 
                            # (in this example foo/, bar/)

    ├── foo                 # For each VPC, the .config.yaml file contains the 
                            # configuration (implementing most of the net-vpc 
                            # variable surface in yaml), and how that VPC 
                            # connects to the internet (via nat_config) or 
                            # other VPCs (via peering_config and ncc_config)

        ├── firewall-rules  # VPC Firewall rules factory path, implemented as 
                            # a net-vpc-firewall factory

        ├── subnets         # Subnets factory path, implemented as subfactory 
                            # of the net-vpc module

        └── vpns            # VPN factory path. Each file describes a VPN 
                            # gateway, a peer, and a trunk of VPN tunnels. Both
                            # GCP-to-GCP and GCP-to-external peers are supported


```

### Networking projects

A [project factory](../../../modules/project-factory/) is embedded in this stage ([factory-projects.tf](./factory-projects.tf)) to allow for the creation of one or multiple projects where the networking resources will be deployed.

The project factory is configured via YAML files in the `projects` directory of your chosen dataset. Each file defines a project, its services, and IAM bindings.

Note that the stage doesn't force you to create projects - as all the factories allow for passing an externally-managed project id.

### VPCs

The VPC factory allows for the definition of an arbitrary number of VPCs, along with subnets, routes, firewall rules and VPC connectivity in YAML files.

VPCs are defined in `.config.yaml` files within the `vpcs` directory of a dataset. Each subdirectory of the `vpcs` directory corresponds to a VPC. The `.config.yaml` file contains the VPC's configuration.

Subnets, firewall rules and VPNs are defined in subdirectories within each VPC's directory.

### DNS

The DNS factory allows for the definition of Cloud DNS zones and records, including RPZ.

DNS zones are defined in YAML files in the `dns/zones` directory of your chosen dataset. The factory supports forwarding, peering and private zones, as well as DNS response policies in the `dns/response-policies`.

### Cloud NAT and Routers

- **Cloud NAT:** The `factory-cloudnat.tf` file manages Cloud NAT gateways, allowing instances without external IP addresses to access the internet.

- **Cloud Routers:** The `factory-routers.tf` file manages Cloud Routers, which are used with Cloud VPN and Cloud Interconnect to exchange routes between your VPC network and your on-premises network.

## Context-based interpolation

Interpolation allow referring to resources which are either created at runtime, or externally managed via short aliases.

This feature has two main benefits:

- being able to refer to resource ids which cannot be known before creation, for example the VPC self link for a VPC created at runtime
- making YAML configuration files more easily readable and portable, by using mnemonic keys which are not specific to an organization or project

The two VPC snippets below show an extended example:

```yaml
# Hub
project_id: $project_ids:net-core-0
name: hub
delete_default_routes_on_create: false
nat_config:
  nat-ew8:
    region: $locations:primary
peering_config:
  to-prod:
    peer_network: $networks:prod
```

```yaml
# Prod spoke
project_id: $project_ids:net-prod-0
name: prod
delete_default_routes_on_create: false
mtu: 1500
nat_config:
  nat-ew8:
    region: $locations:primary
peering_config:
  to-hub:
    peer_network: $networks:hub
```

Interpolations leverage contexts from two separate sources: resources managed by the different factories (projects, folders, vpcs, cloudnat, routers, vpns, etc...), and user-defined resource ids passed in via the `context` variable.

Context replacements use the `$` prefix and are accessible via namespaces that match the attributes in the context variable.

Context variables are accessed by keys that match the YAML file name for resources declared in individual files (projects, folders, custom roles, etc.), or the key in the YAML map where the resource is declared for other resources (service accounts, buckets, etc.). In case of objects that are logically part of another resource (e.g. NCC Groups part of NCC Hubs, Routers part of a VPC), the key will be composite.

Assuming keys of the form `my_folder`, `my_project`, `my_vpc`, etc. this is an example of referencing the actual IDs via interpolation in YAML files.

- `$addresses:my_vpc/my_address`
- `$folder_ids:my_folder`
- `$locations:my_region`
- `$ncc_groups:my_hub/my_group`
- `$ncc_hubs:my_hub`
- `$networks:my_vpc`
- `$project_ids:my_project`
- `$routers:my_vpc/my_vpn`
- `$vpn_gateways:my_vpc/my_gateway`

Internally created resources are mapped to context namespaces, and use specific prefixes to express the relationship with their container.

<!-- TFDOC OPTS files:1 -->
<!-- BEGIN TFDOC -->
## Files

| name | description | modules | resources |
|---|---|---|---|
| [factory-cloudnat.tf](./factory-cloudnat.tf) | Cloud NAT factory. | <code>net-cloudnat</code> |  |
| [factory-dns.tf](./factory-dns.tf) | DNS zones and RPZ factory. | <code>dns</code> · <code>dns-response-policy</code> |  |
| [factory-firewall-policies.tf](./factory-firewall-policies.tf) | Firewall policies factory. | <code>net-firewall-policy</code> |  |
| [factory-ncc.tf](./factory-ncc.tf) | NCC Hubs and Groups factory |  | <code>google_network_connectivity_group</code> · <code>google_network_connectivity_hub</code> · <code>google_network_connectivity_spoke</code> |
| [factory-nva.tf](./factory-nva.tf) | NVA factory | <code>compute-vm</code> · <code>net-lb-int</code> | <code>google_compute_instance_group</code> |
| [factory-peering.tf](./factory-peering.tf) | VPC Peering factory. |  | <code>google_compute_network_peering</code> |
| [factory-projects.tf](./factory-projects.tf) | Projects factory. | <code>project-factory</code> |  |
| [factory-routers.tf](./factory-routers.tf) | Routers factory. |  | <code>google_compute_router</code> |
| [factory-vpcs.tf](./factory-vpcs.tf) | VPC and firewall rules factory. | <code>net-vpc</code> · <code>net-vpc-firewall</code> |  |
| [factory-vpns.tf](./factory-vpns.tf) | VPNs factory. | <code>net-vpn-ha</code> | <code>google_compute_ha_vpn_gateway</code> |
| [main.tf](./main.tf) | Module-level locals and resources. |  |  |
| [outputs.tf](./outputs.tf) | Module outputs. |  | <code>google_storage_bucket_object</code> · <code>local_file</code> |
| [variables-fast.tf](./variables-fast.tf) | None |  |  |
| [variables.tf](./variables.tf) | Module variables. |  |  |

## Variables

| name | description | type | required | default |
|---|---|:---:|:---:|:---:|
| [automation](variables-fast.tf#L17) | Automation resources created by the bootstrap stage. | <code title="object&#40;&#123;&#10;  outputs_bucket &#61; string&#10;&#125;&#41;">object&#40;&#123;&#8230;&#125;&#41;</code> | ✓ |  |
| [billing_account](variables-fast.tf#L26) | Billing account id. | <code title="object&#40;&#123;&#10;  id &#61; string&#10;&#125;&#41;">object&#40;&#123;&#8230;&#125;&#41;</code> | ✓ |  |
| [organization](variables-fast.tf#L58) | Organization details. | <code title="object&#40;&#123;&#10;  id &#61; number&#10;&#125;&#41;">object&#40;&#123;&#8230;&#125;&#41;</code> | ✓ |  |
| [prefix](variables-fast.tf#L67) | Prefix used for resources that need unique names. Use a maximum of 9 chars for organizations, and 11 chars for tenants. | <code>string</code> | ✓ |  |
| [context](variables.tf#L17) | Context-specific interpolations. | <code title="object&#40;&#123;&#10;  custom_roles   &#61; optional&#40;map&#40;string&#41;, &#123;&#125;&#41;&#10;  folder_ids     &#61; optional&#40;map&#40;string&#41;, &#123;&#125;&#41;&#10;  iam_principals &#61; optional&#40;map&#40;string&#41;, &#123;&#125;&#41;&#10;  locations      &#61; optional&#40;map&#40;string&#41;, &#123;&#125;&#41;&#10;  project_ids    &#61; optional&#40;map&#40;string&#41;, &#123;&#125;&#41;&#10;  tag_keys       &#61; optional&#40;map&#40;string&#41;, &#123;&#125;&#41;&#10;  tag_values     &#61; optional&#40;map&#40;string&#41;, &#123;&#125;&#41;&#10;&#125;&#41;">object&#40;&#123;&#8230;&#125;&#41;</code> |  | <code>&#123;&#125;</code> |
| [custom_roles](variables-fast.tf#L34) | Custom roles defined at the org level, in key => id format. | <code>map&#40;string&#41;</code> |  | <code>&#123;&#125;</code> |
| [factories_config](variables.tf#L32) | Configuration for the resource factories or external data. | <code title="object&#40;&#123;&#10;  defaults              &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;defaults.yaml&#34;&#41;&#10;  dns                   &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;dns&#47;zones&#34;&#41;&#10;  dns-response-policies &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;dns&#47;response-policies&#34;&#41;&#10;  firewall-policies     &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;firewall-policies&#34;&#41;&#10;  folders               &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;folders&#34;&#41;&#10;  interconnect          &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;interconnect&#34;&#41;&#10;  ncc-hubs              &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;ncc-hubs&#34;&#41;&#10;  nvas                  &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;nvas&#34;&#41;&#10;  projects              &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;projects&#34;&#41;&#10;  vpcs                  &#61; optional&#40;string, &#34;datasets&#47;hub-and-spokes-peerings&#47;vpcs&#34;&#41;&#10;&#125;&#41;">object&#40;&#123;&#8230;&#125;&#41;</code> |  | <code>&#123;&#125;</code> |
| [folder_ids](variables-fast.tf#L42) | Folders created in the bootstrap stage. | <code>map&#40;string&#41;</code> |  | <code>&#123;&#125;</code> |
| [iam_principals](variables-fast.tf#L50) | IAM-format principals. | <code>map&#40;string&#41;</code> |  | <code>&#123;&#125;</code> |
| [outputs_location](variables.tf#L50) | Path where tfvars files for the following stages are written. Leave empty to disable. | <code>string</code> |  | <code>null</code> |
| [project_ids](variables-fast.tf#L77) | Projects created in the bootstrap stage. | <code>map&#40;string&#41;</code> |  | <code>&#123;&#125;</code> |
| [service_accounts](variables-fast.tf#L85) | Service accounts created in the bootstrap stage. | <code>map&#40;string&#41;</code> |  | <code>&#123;&#125;</code> |
| [tag_keys](variables-fast.tf#L93) | FAST-managed resource manager tag keys. | <code>map&#40;string&#41;</code> |  | <code>&#123;&#125;</code> |
| [tag_values](variables-fast.tf#L101) | FAST-managed resource manager tag values. | <code>map&#40;string&#41;</code> |  | <code>&#123;&#125;</code> |
| [universe](variables.tf#L56) | GCP universe where to deploy projects. The prefix will be prepended to the project id. | <code title="object&#40;&#123;&#10;  domain                         &#61; string&#10;  prefix                         &#61; string&#10;  forced_jit_service_identities  &#61; optional&#40;list&#40;string&#41;, &#91;&#93;&#41;&#10;  unavailable_services           &#61; optional&#40;list&#40;string&#41;, &#91;&#93;&#41;&#10;  unavailable_service_identities &#61; optional&#40;list&#40;string&#41;, &#91;&#93;&#41;&#10;&#125;&#41;">object&#40;&#123;&#8230;&#125;&#41;</code> |  | <code>null</code> |

## Outputs

| name | description | sensitive |
|---|---|:---:|
| [host_project_ids](outputs.tf#L65) | Project IDs. |  |
| [host_project_numbers](outputs.tf#L70) | Project numbers. |  |
| [subnet_proxy_only_self_links](outputs.tf#L75) | Subnet proxy-only self-links. |  |
| [subnet_psc_self_links](outputs.tf#L80) | Subnet PSC self-links. |  |
| [subnet_self_links](outputs.tf#L85) | Subnet self-links. |  |
| [vpc_self_links](outputs.tf#L90) | VPC self-links. |  |
<!-- END TFDOC -->
