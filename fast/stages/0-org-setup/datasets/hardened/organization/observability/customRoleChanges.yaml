# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

alerts:
  customRoleChanges:
    combiner: OR
    conditions:
    - condition_threshold:
        aggregations:
        - alignment_period: 60s
          cross_series_reducer: REDUCE_SUM
          group_by_fields:
          - metric.label.principal
          - metric.label.method_name
          - metric.label.organization_id
          - metric.label.project_id
          - metric.label.role_name
          per_series_aligner: ALIGN_SUM
        comparison: COMPARISON_GT
        duration: 0s
        filter: resource.type = "logging_bucket" AND metric.type = "logging.googleapis.com/user/customRoleChanges"
        threshold_value: 0
        trigger:
          count: 1
      display_name: 'Log match condition: custom role changes'
    display_name: Custom Role Changes
    documentation:
      content: "Log-based alerting policy in project ${project} detected custom IAM\
        \ role creation, deletion or update activities.\nThis alert helps ensure security\
        \ by monitoring changes to Identity and Access Management (IAM) roles. ```\n\
        \  resource.type=\"iam_role\" AND \n  (\n    protoPayload.methodName=\"google.iam.admin.v1.CreateRole\"\
        \ OR \n    protoPayload.methodName=\"google.iam.admin.v1.UpdateRole\" OR \n\
        \    protoPayload.methodName=\"google.iam.admin.v1.DeleteRole\"\n  )\n```"
      mime_type: text/markdown
logging_metrics:
  customRoleChanges:
    bucket_name: organization-log-bucket
    description: Custom Role Changes
    filter: "resource.type=\"iam_role\" AND (\n  protoPayload.methodName=\"google.iam.admin.v1.CreateRole\"\
      \ OR\n  protoPayload.methodName=\"google.iam.admin.v1.UpdateRole\" OR\n  protoPayload.methodName=\"\
      google.iam.admin.v1.DeleteRole\"\n)"
    label_extractors:
      method_name: EXTRACT(protoPayload.methodName)
      organization_id: EXTRACT(labels.organization_id)
      principal: EXTRACT(protoPayload.authenticationInfo.principalEmail)
      project_id: EXTRACT(labels.project_id)
      role_name: EXTRACT(labels.role_name)
    metric_descriptor:
      labels:
      - description: principal
        key: principal
        value_type: STRING
      - description: method_name
        key: method_name
        value_type: STRING
      - description: organization_id
        key: organization_id
        value_type: STRING
      - description: project_id
        key: project_id
        value_type: STRING
      - description: role_name
        key: role_name
        value_type: STRING
      metric_kind: DELTA
      unit: '1'
      value_type: INT64
