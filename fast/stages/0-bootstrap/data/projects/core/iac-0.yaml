# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# yaml-language-server: $schema=../../../schemas/project.schema.json

# TODO: data access logs configuration
name: prod-iac-core-0
iam_by_principals:
  $iam_principals:gcp-organization-admins:
    - roles/iam.serviceAccountTokenCreator
    - roles/iam.workloadIdentityPoolAdmin
  $iam_principals:service_accounts/iac-0/iac-bootstrap-ro:
    - roles/browser
    - roles/cloudbuild.builds.viewer
    - roles/iam.serviceAccountViewer
    - roles/iam.workloadIdentityPoolViewer
    - $custom_roles:storage_viewer
    - roles/viewer
  $iam_principals:service_accounts/iac-0/iac-bootstrap-rw:
    - roles/cloudbuild.builds.editor
    - roles/iam.serviceAccountAdmin
    - roles/iam.workloadIdentityPoolAdmin
    - roles/owner
    - roles/storage.admin
services:
  - accesscontextmanager.googleapis.com
  - bigquery.googleapis.com
  - bigqueryreservation.googleapis.com
  - bigquerystorage.googleapis.com
  - billingbudgets.googleapis.com
  - cloudasset.googleapis.com
  - cloudbilling.googleapis.com
  - cloudbuild.googleapis.com
  - cloudkms.googleapis.com
  - cloudquotas.googleapis.com
  - cloudresourcemanager.googleapis.com
  - compute.googleapis.com
  - container.googleapis.com
  - datacatalog.googleapis.com
  - essentialcontacts.googleapis.com
  - iam.googleapis.com
  - iamcredentials.googleapis.com
  - logging.googleapis.com
  - monitoring.googleapis.com
  - networksecurity.googleapis.com
  - orgpolicy.googleapis.com
  - pubsub.googleapis.com
  - servicenetworking.googleapis.com
  - serviceusage.googleapis.com
  - storage-component.googleapis.com
  - storage.googleapis.com
  - sts.googleapis.com
org_policies:
  iam.workloadIdentityPoolProviders:
    rules:
      - allow:
          values:
            - https://token.actions.githubusercontent.com
            - https://gitlab.com
            - https://app.terraform.io
buckets:
  # Terraform state bucket for this stage
  iac-bootstrap-state:
    description: Terraform state for the org-level automation.
    iam:
      roles/storage.admin:
        - $iam_principals:service_accounts/iac-0/iac-bootstrap-rw
      $custom_roles:storage_viewer:
        - $iam_principals:service_accounts/iac-0/iac-bootstrap-ro
  # Terraform state bucket for additional FAST stages
  iac-stage-state:
    description: Terraform state for stage automation.
    managed_folders:
      1-vpcsc:
        iam:
          roles/storage.admin:
            - $iam_principals:service_accounts/iac-0/iac-vpcsc-rw
          $custom_roles:storage_viewer:
            - $iam_principals:service_accounts/iac-0/iac-vpcsc-ro
      2-networking:
        iam:
          roles/storage.admin:
            - $iam_principals:service_accounts/iac-0/iac-networking-rw
          $custom_roles:storage_viewer:
            - $iam_principals:service_accounts/iac-0/iac-networking-ro
      2-security:
        iam:
          roles/storage.admin:
            - $iam_principals:service_accounts/iac-0/iac-security-rw
          $custom_roles:storage_viewer:
            - $iam_principals:service_accounts/iac-0/iac-security-ro
      2-project-factory:
        iam:
          roles/storage.admin:
            - $iam_principals:service_accounts/iac-0/iac-pf-rw
          $custom_roles:storage_viewer:
            - $iam_principals:service_accounts/iac-0/iac-pf-ro
  # Terraform state bucket for FAST outputs
  iac-outputs:
    description: Terraform state for the org-level automation.
    iam:
      roles/storage.admin:
        - $iam_principals:service_accounts/iac-0/iac-bootstrap-rw
        - $iam_principals:service_accounts/iac-0/iac-networking-rw
        - $iam_principals:service_accounts/iac-0/iac-security-rw
        - $iam_principals:service_accounts/iac-0/iac-pf-rw
        - $iam_principals:service_accounts/iac-0/iac-vpcsc-rw
      $custom_roles:storage_viewer:
        - $iam_principals:service_accounts/iac-0/iac-bootstrap-ro
        - $iam_principals:service_accounts/iac-0/iac-networking-ro
        - $iam_principals:service_accounts/iac-0/iac-security-ro
        - $iam_principals:service_accounts/iac-0/iac-pf-ro
        - $iam_principals:service_accounts/iac-0/iac-vpcsc-ro
service_accounts:
  # IaC service accounts for this stage
  iac-bootstrap-ro:
    display_name: IaC service account for bootstrap (read-only).
  iac-bootstrap-rw:
    display_name: IaC service account for bootstrap (read-write).
  # CI/CD service accounts for this stage
  iac-bootstrap-cicd-ro:
    display_name: IaC service account for bootstrap CI/CD (read-only).
    iam_sa_roles:
      $service_account_ids:iac-0/iac-bootstrap-ro:
        - roles/iam.workloadIdentityUser
  iac-bootstrap-cicd-rw:
    display_name: IaC service account for bootstrap CI/CD (read-write).
    iam_sa_roles:
      $service_account_ids:iac-0/iac-bootstrap-rw:
        - roles/iam.workloadIdentityUser
  # IaC service accounts for vpc-sc stage
  iac-vpcsc-ro:
    display_name: IaC service account for VPC service controls (read-only).
  iac-vpcsc-rw:
    display_name: IaC service account for VPC service controls (read-write).
  # IaC service accounts for networking stage
  iac-networking-ro:
    display_name: IaC service account for networking (read-only).
  iac-networking-rw:
    display_name: IaC service account for networking (read-write).
  # IaC service accounts for security stage
  iac-security-ro:
    display_name: IaC service account for security (read-only).
  iac-security-rw:
    display_name: IaC service account for security (read-write).
  # IaC service accounts for project factory stage
  iac-pf-ro:
    display_name: IaC service account for project factory (read-only).
  iac-pf-rw:
    display_name: IaC service account for project factory (read-write).
