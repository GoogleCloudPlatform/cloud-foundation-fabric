# Azure Devops Pipelines via Workload Identity Federation

## Workload Identity Federation

### Azure Devops Service Connection

On the Azure Devops side, configure a Service Connection as explained in the ["Prepare your external IdP"](https://docs.cloud.google.com/iam/docs/workload-identity-federation-with-deployment-pipelines#prepare) section of the Workload Identity documentation.

Once the service connection is configured, copy the "Issuer" and "Subject identifier" displayed in the Service Connection's "Workload Identity federation details", which will be used to configure the WIF provider and associated IAM roles.

Your pipelines will need to be authorized to use this service connection, but this is a simple step and you can do it when you run the pipeline for the first time.

### GCP Workload Identity Federation Pool and Provider

Other than the issuer coming from the Service Connection, one additional source of information is also needed before we can complete the WIF provider configuration.

The provider allows defining an attribute condition, which is used to restrict the set of supported tokens. This is entirely optional, but it's good practice to define it as a preventive control, to avoid potential risks in IAM bindings that use principals mapped to these tokens.

The attribute condition is a CEL expression that checks assertions in the JWT token, and the only information we can use in the tokens generated by Azure Devops are the object id of the Azure Devops enterprise application (`assertion.oid`), and the Azure tenant id (`assertion.tid`). The condition in the example below only uses `oid`, but you can mix and match depending on specific needs.

The last bit of information needed for the WIF provider configuration is the set of allowed audiences, which in this case is entirely static and contains a single object id for the AAD Token Exchange Endpoint.

Find the following definition in the `project.yaml` file and edit it to reflect your desired values. When multiple pipelines need to be mapped to different IAM principals on the GCP side, one Service Connection and one WIF provider are needed for each of them. The WIF pool though can stay the same.

```yaml
workload_identity_pools:
  # pool name on GCP
  cicd-0:
    display_name: CI/CD pool.
    providers:
      # provider name on GCP, multiple providers are supported here
      az-test:
        display_name: Azure Devops test.
        # use the object id of the AZD enterprise application in your Entra
        # the Azure tenant id (assertion.tid) can also be used
        attribute_condition: assertion.oid=="6f90190a-864b-4915-a9b2-eef076afa596"
        attribute_mapping:
          # google.subject: assertion.sub
          google.subject: assertion.sub.split("/sc/")[1]
        identity_provider:
          oidc:
            # use the issuer displayed in the service connection details
            issuer_uri: https://login.microsoftonline.com/a659ec42-b896-4739-824b-1d75def8ce3a/v2.0
            # you do not need to change this
            allowed_audiences:
              # - api://AzureADTokenExchange
              - fb60f99c-7a34-4190-8149-302f77469936
```
