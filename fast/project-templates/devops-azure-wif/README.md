# Azure Devops Pipelines via Workload Identity Federation

<!-- BEGIN TOC -->
- [Project Configuration](#project-configuration)
  - [Organization Policies](#organization-policies)
  - [Data Access Logs](#data-access-logs)
  - [Hosted vs Managed Agents](#hosted-vs-managed-agents)
- [Workload Identity Federation](#workload-identity-federation)
  - [Azure Devops Service Connection](#azure-devops-service-connection)
  - [GCP Workload Identity Federation Pool and Provider](#gcp-workload-identity-federation-pool-and-provider)
  - [IAM principals](#iam-principals)
<!-- END TOC -->

## Project Configuration

The provided `project.yaml` file provides an initial configuration, and makes a few assumptions that are explained in this section. This setup will only cover direct requirements for the Azure Devops integration, and assume that environment-specific customizations (project id, parent folder reference, specific IAM settings, region, etc.) will be implemented by the user.

### Organization Policies

A big part of the configuration outlined here involves setting up a Workload Identity Federation pool and provider. Depending on the organizational setup, this might require relaxing organization policies like in this example.

Comment this out of this is already in place in the parent hierarchy.

```yaml
org_policies:
  iam.workloadIdentityPoolProviders:
    rules:
      - allow:
          all: true
```

### Data Access Logs

Workload Identity Federation often requires some amount of troubleshooting to make sure the IAM principals match the assertions in the tokens provided by the external IdP (Azure Devops in this case). This is made easier by turning on data access logs for specific services, like in this example, and also allows logging token exchanges.

Comment this out if you don't need to troubleshoot, or don't want to track token exchanges.

```yaml
data_access_logs:
  iam.googleapis.com:
    ADMIN_READ: {}
    DATA_READ: {}
    DATA_WRITE: {}
  sts.googleapis.com:
    ADMIN_READ: {}
    DATA_READ: {}
    DATA_WRITE: {}
```

### Hosted vs Managed Agents

The services enabled at the project level include those required for hosted agents running on Compute instances, and pulling their container image from Artifact Registry. These can be commented out if only managed agents are used. Keep the rest of the services in the block, which are not shown here.

```yaml
services:
  # - artifactregistry.googleapis.com
  # - compute.googleapis.com
```

The same applies to the `vm-default` service account, which is only needed for hosted agents. The following can be commented out if only managed agents are used. Keep the rest of the definitions in both `iam_principals` and `service_accounts`, which are not shown here.

```yaml
iam_by_principals:
  # serviceAccount:vm-default@ldj-prod-net-landing-0.iam.gserviceaccount.com:
  #   - roles/artifactregistry.writer
service_accounts:
  # vm-default:
  #   display_name: VM default service account.
```

## Workload Identity Federation

### Azure Devops Service Connection

On the Azure Devops side, configure a Service Connection as explained in the ["Prepare your external IdP"](https://docs.cloud.google.com/iam/docs/workload-identity-federation-with-deployment-pipelines#prepare) section of the Workload Identity documentation.

Once the service connection is configured, copy the "Issuer" and "Subject identifier" displayed in the Service Connection's "Workload Identity federation details", which will be used to configure the WIF provider and associated IAM roles.

Your pipelines will need to be authorized to use this service connection, but this is a simple step and you can do it when you run the pipeline for the first time.

### GCP Workload Identity Federation Pool and Provider

Other than the issuer coming from the Service Connection, one additional source of information is also needed before we can complete the WIF provider configuration.

The provider allows defining an attribute condition, which is used to restrict the set of supported tokens. This is entirely optional, but it's good practice to define it as a preventive control, to avoid potential risks in IAM bindings that use principals mapped to these tokens.

The attribute condition is a CEL expression that checks assertions in the JWT token, and the only information we can use in the tokens generated by Azure Devops are the object id of the Azure Devops enterprise application (`assertion.oid`), and the Azure tenant id (`assertion.tid`). The condition in the example below only uses `oid`, but you can mix and match depending on specific needs.

The last bit of information needed for the WIF provider configuration is the set of allowed audiences, which in this case is entirely static and contains a single object id for the AAD Token Exchange Endpoint.

Find the following definition in the `project.yaml` file and edit it to reflect your desired values. When multiple pipelines need to be mapped to different IAM principals on the GCP side, one Service Connection and one WIF provider are needed for each of them. The WIF pool though can stay the same.

```yaml
workload_identity_pools:
  # pool name on GCP
  cicd-0:
    display_name: CI/CD pool.
    providers:
      # provider name on GCP, multiple providers are supported here
      az-test:
        display_name: Azure Devops test.
        # use the object id of the AZD enterprise application in your Entra
        # the Azure tenant id (assertion.tid) can also be used
        attribute_condition: assertion.oid=="6f90190a-864b-4915-a9b2-eef076afa596"
        attribute_mapping:
          google.subject: assertion.sub.split("/sc/")[1]
        identity_provider:
          oidc:
            # use the issuer displayed in the service connection details
            issuer_uri: https://login.microsoftonline.com/a659ec42-b896-4739-824b-1d75def8ce3a/v2.0
            # you do not need to change this
            allowed_audiences:
              # - api://AzureADTokenExchange
              - fb60f99c-7a34-4190-8149-302f77469936
```

### IAM principals

IAM principals for Azure Devops tokens mapped via the Workload Identity configuration above, will only be able to use the assertion subject identifier. Azure Devops does not populate organization, project, repository, or pipeline information in the token so the Service Connection (which defines the subject) can be mapped to a single principal on the GCP side.

Moreover, since the subject is a long string there's a high chance that it will exceed the number of characters supported by Workload Identity Federation. This is the reason why the WIF provider mapping is defined as `assertion.sub.split("/sc/")[1]`: the subject is split into two parts, and only the second part (which contains the service connection id) is kept.

So for a Service Connection that defines this subject:

```
/eid1/c/pub/t/QuxZppa4OUeCSx113vjOOg/a/rISbSSETf0KqFyZ8ppdXmA/sc/5d2face9-4998-4294-8d24-763e98b6af3e/9e92fe65-c282-47ee-9534-3a1a784c3417
```

The `google.subject` used to construct the IAM principal will be composed of your Azure Devops [organization id](https://stackoverflow.com/a/67871296) and the id of the Service Connection:

```
5d2face9-4998-4294-8d24-763e98b6af3e/9e92fe65-c282-47ee-9534-3a1a784c3417
```

So we finally get to the IAM principal, which for the service connection above has this form:

```
principal://iam.googleapis.com/projects/[project number]/locations/global/workloadIdentityPools/[pool name]/subject/5d2face9-4998-4294-8d24-763e98b6af3e/9e92fe65-c282-47ee-9534-3a1a784c3417
```

## Agent Configuration

### Microsoft-Hosted Agents

The easy path for agent selection is to use [Microsoft-hosted agents](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&tabs=windows-images%2Cyaml), which only require permissions to be granted to the relevant pipelines.

### Self-Hosted Agents

If [self-hosted agents](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/linux-agent?view=azure-devops&tabs=IP-V4) are required, a sample Container Optimized OS based agent is provided as part of this example.

Several steps are needed to bootstrap the provided example for a hosted agent:

- build the Docker image according to the [Microsoft-provided documentation](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops#linux)
- enable the Artifact Registry provided as part of this example via the `hosted_agent_config.create_registry` variable
- create an agent token on Azure Devops and save it to a local `token.txt` file
- apply Terraform so that the Artifact Registry and token secrets are created
- copy the registry URL from the Terraform outputs, then tag and push the built image
- configure the rest of the `hosted_agent_config` variable and apply Terraform to deploy the hosted agent

This is a sample configuration for the `hosted_agent_config` variable:

```hcl
# TODO: provide example
```

## Pipeline Configuration

### Branch Policies & Permissions

To enable the Pull Request pipeline to function correctly, specifically to trigger on PR creation and post comments/status checks back to the PR, two key configurations are required in Azure DevOps:

1. **Branch Policies (Build Validation):**
    - Navigate to **Project Settings** -> **Repositories**.
    - Select your repository and go to the **Policies** tab.
    - Select the target branch (e.g., `main`).
    - Under **Build Validation**, add a new policy.
    - Select your pipeline and ensure the "Trigger" is set to "Automatic".
    - *Note:* The `pr:` trigger in the YAML file is effectively ignored unless this policy is in place.

2. **Build Service Permissions:**
    - Navigate to **Project Settings** -> **Repositories**.
    - Select your repository and go to the **Security** tab.
    - Locate the **Build Service** accounts (e.g., "Project Collection Build Service" and "[Project Name] Build Service").
    - Set the **"Contribute to pull requests"** permission to **Allow**.
    - *Reason:* This permission is required for the pipeline to post the Terraform Plan output as a comment and to update the PR status check using the System Access Token.

- [Pipelines Schema Reference](https://learn.microsoft.com/en-us/azure/devops/pipelines/yaml-schema/view=azure-pipelines>)
- [Azure Pipelines Terraform (GitHub)](https://github.com/microsoft/azure-pipelines-terraform)
- [Article](https://spacelift.io/blog/terraform-azure-devops)
- [Article](https://medium.com/@guilherme.pompgetting-started-with-terraform-azure-devops-pipelines-with-terraform-924279e5c033>)
